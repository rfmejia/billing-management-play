package controllers

import com.nooovle._
import com.nooovle.slick.ConnectionFactory
import com.github.tototoshi.slick.H2JodaSupport
import com.nooovle.slick.models._
import org.joda.time.{ DateTime, YearMonth }
import org.locker47.json.play._
import play.api._
import play.api.libs.json._
import play.api.mvc.{ Action, RequestHeader, Result }
import scala.slick.driver.H2Driver.simple._
import scala.util.{ Try, Success, Failure }
import securesocial.core._

class Reports(override implicit val env: RuntimeEnvironment[User])
  extends ApiController[User] {

  def show(year: Option[Int], month: Option[Int]) = SecuredAction { implicit request =>
    (year, month) match {
      case (None, _) => listYears()
      case (Some(_year), None) => listMonths(_year)
      case (Some(_year), Some(_month)) =>
        val forMonth = new YearMonth(_year, _month)
        val docs = ConnectionFactory.connect withSession { implicit session =>
          val query = for (doc <- documents if doc.year === _year && doc.month === _month) yield doc
          query.list
        }

        val previous: Amounts = docs.map(doc => Templates.extractSection(doc, "previous"))
          .foldLeft(Amounts.Zero)(_ + _)
        val rent = docs.map(doc => Templates.extractSection(doc, "rent"))
          .foldLeft(Amounts.Zero)(_ + _)
        val electricity = docs.map(doc => Templates.extractSection(doc, "electricity"))
          .foldLeft(Amounts.Zero)(_ + _)
        val water = docs.map(doc => Templates.extractSection(doc, "water"))
          .foldLeft(Amounts.Zero)(_ + _)
        val cusa = docs.map(doc => Templates.extractSection(doc, "cusa"))
          .foldLeft(Amounts.Zero)(_ + _)

        val isPaid: Boolean =
          List(previous, rent, electricity, water, cusa).foldLeft(true)(_ && _.isPaid)

        val self = routes.Reports.show(year, month)
        val generationTime = DateTime.now
        val obj = HalJsObject.create(self.absoluteURL())
          .withCurie("hoa", Application.defaultCurie)
          .withLink("profile", "hoa:report")
          .withLink("hoa:user", routes.Users.show(request.user.userId).absoluteURL(),
            Some("Generated by"))
          .withField("forMonth", JsObject(Seq(
            "name" -> JsString(forMonth.monthOfYear.getAsText()),
            "month" -> JsNumber(forMonth.getMonthOfYear),
            "year" -> JsNumber(forMonth.getYear))))
          .withField("generated", JsObject(Seq(
            "name" -> JsString(generationTime.monthOfYear.getAsText()),
            "month" -> JsNumber(generationTime.getMonthOfYear),
            "year" -> JsNumber(generationTime.getYear))))
          .withField("count", docs.size)
          .withField("amounts",
            HalJsObject.empty
              .withField("isPaid", JsBoolean(isPaid))
              .withField("sections", JsArray(List(
                JsObject(Seq("name" -> JsString("previous"),
                  "amounts" -> previous.asJsObject)),
                JsObject(Seq("name" -> JsString("rent"),
                  "amounts" -> rent.asJsObject)),
                JsObject(Seq("name" -> JsString("electricity"),
                  "amounts" -> electricity.asJsObject)),
                JsObject(Seq("name" -> JsString("water"),
                  "amounts" -> water.asJsObject)),
                JsObject(Seq("name" -> JsString("cusa"),
                  "amounts" -> cusa.asJsObject)))))
              .asJsValue)
        Ok(obj.asJsValue)
    }
  }

  def listYears(): Result = NotImplemented
  def listMonths(year: Int): Result = NotImplemented
}
